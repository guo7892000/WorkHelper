### 实例-物品台账查询
```
/*物品台账查询：查询某个物品的期初、入出明细（包含入出后的期末数）
入参：DLR_ID、PART_NO、START_TIME、END_TIME*/
WITH MAX_BALANCE_MONTH AS
(/*取得小于开始统计时间的专营店最大月结月份*/
  SELECT MAX(M.BALANCE_MONTH) AS BALANCE_MONTH
    FROM T_GD_BU_DLR_STORE_MONTH M
   WHERE 1 = 1
     AND M.BALANCE_MONTH < TO_CHAR('#START_TIME#', 'YYYYMM')
     AND M.DLR_ID = '#DLR_ID#'),
MIN_BALANCE_MONTH AS
 (/*取得专营店的最小月结月份*/
 SELECT MIN(M.BALANCE_MONTH) AS BALANCE_MONTH,
         TO_CHAR('#START_TIME#', 'YYYYMM') AS BEGIN_DATE
    FROM T_GD_BU_DLR_STORE_MONTH M
   WHERE 1 = 1
     AND M.DLR_ID = '#DLR_ID#'),
FIRST_LAST_TIME AS
 (/*取得最小的入出开始时间：一般为月结时间，因为是以月结时间+小于开始时间的入出单作为期初*/
 SELECT NVL2(NVL(A.BALANCE_MONTH, B.BALANCE_MONTH),
              TO_DATE(TO_CHAR(LAST_DAY(TO_DATE(NVL(A.BALANCE_MONTH,
                                                   NVL(B.BALANCE_MONTH,
                                                       B.BEGIN_DATE)),
                                               'YYYY-MM')),
                              'YYYY-MM-DD') || ' 23:59:59',
                      'YYYY-MM-DD hh24:mi:ss'),
              NULL) AS LAST_CHECK_TIME
    FROM MAX_BALANCE_MONTH A, MIN_BALANCE_MONTH B),
GET_STORE_MONTH_ID AS
 (/*取得专营店的月结ID*/
 SELECT NVL2(NVL(A.BALANCE_MONTH, B.BALANCE_MONTH),
              (SELECT M.STORE_MONTH_ID
                 FROM T_GD_BU_DLR_STORE_MONTH M
                WHERE M.BALANCE_MONTH = NVL(A.BALANCE_MONTH, B.BALANCE_MONTH)
                  AND M.DLR_ID = '#DLR_ID#'
                  AND ROWNUM = 1),
              NULL) AS STORE_MONTH_ID
    FROM MAX_BALANCE_MONTH A, MIN_BALANCE_MONTH B),
T_GD_TEMP_ORDER_SOTRE_MONTH AS
 (/*物品的月结以及入出库单*/
 SELECT TO_DATE(TO_CHAR(TO_DATE(M.BALANCE_MONTH, 'YYYY-MM'), 'YYYY-MM') ||
                 '-01 00:00:00',
                 'YYYY-MM-DD hh24:mi:ss') AS ORDERDATE,
         D.END_QTY AS QTY, --数量
         D.STORE_COST DJ, --不含税成本单价
         D.END_COST AS CB, --不含税成本总价
         D.STORE_PRICE HSDJ, --含税成本单价
         D.END_AMOUNT AS HSCB, --含税成本总价
         D.PART_NO, 
         V.PART_NAME AS PART_NAME,
         D.UNIT AS PART_NUNT,
         D.WAREHOUSE_NAME AS HOUSE_NAME, 
         '' AS PLACE_CODE,
         '0' AS ID,
         -1 AS TYPE, /*期初*/
         '0' AS BILL_TYPE,
         '' AS BILL_NAME,
         '' AS BILL_CODE,
         M.CREATOR,
         '' AS REMARK,
         D.CREATED_DATE,
         M.DLR_ID AS NET_CODE,
         (SELECT NI.DLR_SHORT_NAME AS NET_SHORT_NAME
            FROM T_SYS_ORG_DLR NI
           WHERE M.DLR_ID = NI.DLR_ID) AS NET_NAME,
         M.BALANCE_MONTH,
         M.STORE_MONTH_ID
    FROM T_GD_BU_DLR_STORE_MONTH   M
    join T_GD_BU_DLR_STORE_MONTH_D D 
         on M.STORE_MONTH_ID = D.STORE_MONTH_ID
    join V_PA_QUERY_PART_LIST      V
         on V.PART_ID = D.PART_ID
   WHERE 1=1
     AND M.STORE_MONTH_ID = (SELECT STORE_MONTH_ID FROM GET_STORE_MONTH_ID WHERE ROWNUM = 1)
     AND M.DLR_ID = '#DLR_ID#'
     AND D.PART_NO = '#PART_NO#'
  UNION ALL
  SELECT VI.IN_STORE_DATE AS ORDERDATE, --入退库日期
         DECODE(VI.BILL_BIG_TYPE, '1', VD.IN_STORE_QTY, -1 * VD.IN_STORE_QTY) AS QTY, --入库数量
         VD.STORE_COST AS DJ,
         DECODE(VI.BILL_BIG_TYPE,
                '1',
                VD.STORE_COST_AMOUNT,
                -1 * VD.STORE_COST_AMOUNT) AS CB, --不含税入库成本
         VD.STORE_PRICE AS HSDJ, --含税成本价
         DECODE(VI.BILL_BIG_TYPE,
                '1',
                VD.STORE_PRICE_AMOUNT,
                -1 * VD.STORE_PRICE_AMOUNT) AS HSDJ, --入库退货含税成本
         VD.PART_NO,
         V.PART_NAME AS PART_NAME,
         VD.UNIT,
         W.WAREHOUSE_NAME,
         P.PLACE_CODE,
         VD.IN_STORE_D_ID AS ID,
         0 AS TYPE, /*入库和入库退货*/
         VI.BILL_TYPE,
         DECODE(VI.BILL_BIG_TYPE,
                '1',
                F_DB_GETLOOKVALUE('PA0020', VI.BILL_TYPE, ''),
                F_DB_GETLOOKVALUE('PA0021', VI.BILL_TYPE, '')) AS BILL_NAME,
         VI.IN_STORE_CODE,
         VI.CREATOR,
         VI.RELATE_ORDER_CODE AS REMARK,
         VI.CREATED_DATE,
         VI.DLR_ID,
         MD.DLR_SHORT_NAME,
         '300001' AS BALANCE_MONTH,
         '0' AS STORE_MONTH_ID
    FROM T_GD_BU_DLR_IN_STORE   VI
    join T_GD_BU_DLR_IN_STORE_D VD on VI.IN_STORE_ID = VD.IN_STORE_ID
    join V_PA_QUERY_PART_LIST   V on VD.PART_ID = V.PART_ID
    join T_GD_DB_DLR_WAREHOUSE  W on VI.DLR_ID = W.DLR_ID AND VD.WAREHOUSE_ID = W.WAREHOUSE_ID
    join T_GD_DB_DLR_PLACE      P on VI.DLR_ID = P.DLR_ID and VD.PLACE_ID = P.PLACE_ID
    join T_SYS_ORG_DLR          MD on VI.DLR_ID = MD.DLR_ID
    join FIRST_LAST_TIME        FL on VI.IN_STORE_DATE > FL.LAST_CHECK_TIME 
   WHERE 1=1
     AND VI.DLR_ID = '#DLR_ID#'
     AND VD.PART_NO = '#PART_NO#'
     AND VI.IN_STORE_DATE < '#END_TIME#' + 1
  UNION ALL
  SELECT VO.OUT_STORE_DATE AS ORDERDATE,
         DECODE(VO.BILL_BIG_TYPE,
                '3',
                -1 * VOD.OUT_STORE_QTY,
                VOD.OUT_STORE_QTY) AS OUT_STORE_QTY, --出库为负，出库退库为正                
         VOD.STORE_COST AS DJ,
         DECODE(VO.BILL_BIG_TYPE,
                '3',
                -1 * VOD.STORE_COST_AMOUNT,
                VOD.STORE_COST_AMOUNT) AS CB, --不含税入库成本 出库为负，出库退库为正 
         VOD.STORE_PRICE AS HSDJ,
         DECODE(VO.BILL_BIG_TYPE,
                '3',
                -1 * VOD.STORE_PRICE_AMOUNT,
                VOD.STORE_PRICE_AMOUNT) AS HSDJ, --入库退货含税成本 出库为负，出库退库为正 
         VOD.PART_NO,
         V.PART_NAME AS PART_NAME,
         VOD.UNIT,
         W.WAREHOUSE_NAME,
         P.PLACE_CODE,
         VOD.OUT_STORE_D_ID AS ID,
         1 AS TYPE, /*出库和出库退货*/
         VO.BILL_TYPE,
         DECODE(VO.BILL_BIG_TYPE,
                '3',
                F_DB_GETLOOKVALUE('PA0022', VO.BILL_TYPE, ''),
                F_DB_GETLOOKVALUE('PA0023', VO.BILL_TYPE, '')) AS BILL_NAME, --入出类型
         VO.OUT_STORE_CODE,
         VO.CREATOR,
         VO.RELATE_ORDER_CODE AS REMARK,
         VO.OUT_STORE_DATE, --入出时间
         VO.DLR_ID,
         MD.DLR_SHORT_NAME,
         '300001' AS BALANCE_MONTH,
         '0' AS STORE_MONTH_ID
    FROM T_GD_BU_DLR_OUT_STORE   VO
    join T_GD_BU_DLR_OUT_STORE_D VOD on VO.OUT_STORE_ID = VOD.OUT_STORE_ID
    join V_PA_QUERY_PART_LIST    V on VOD.PART_ID = V.PART_ID
    join T_GD_DB_DLR_WAREHOUSE   W on VO.DLR_ID = W.DLR_ID AND VOD.WAREHOUSE_ID = W.WAREHOUSE_ID
    join T_GD_DB_DLR_PLACE       P on VO.DLR_ID = P.DLR_ID AND VOD.PLACE_ID = P.PLACE_ID
    join T_SYS_ORG_DLR           MD on VO.DLR_ID = MD.DLR_ID
    join FIRST_LAST_TIME         FL on VO.OUT_STORE_DATE > FL.LAST_CHECK_TIME
   WHERE 1=1
     AND VO.DLR_ID = '#DLR_ID#'
     AND VOD.PART_NO = '#PART_NO#'
     AND VO.OUT_STORE_DATE < '#END_TIME#' + 1)
SELECT *
FROM (SELECT 0 AS NUMNO,
             A.NET_NAME,
             '-1' ID,
             -1 TYPE,
             '0' BILL_TYPE,
             to_char(A.ORDERDATE, 'yyyy-mm-dd') as ORDERDATE,
             A.PART_NO,
             A.PART_NAME,
             NULL BILL_CODE,
             '' CREATOR,
             NULL REMARK,
             '期初' AS BILL_NAME,
             NULL AS IN_QTY,
             NULL AS IN_DJ,
             NULL AS IN_HSDJ,
             NULL AS IN_CB,
             NULL AS IN_HSCB,
             NULL AS OUT_QTY,
             NULL AS OUT_DJ,
             NULL AS OUT_HSDJ,
             NULL AS OUT_CB,
             NULL AS OUT_HSCB,
             CAST(NVL(SUM(B.QTY), 0) AS NUMBER(18, 4)) AS END_QTY, /*0月结、1入库、2出库*/
             CAST(DECODE(NVL(SUM(B.QTY), 0),
                         0,
                         0,
                         (NVL(SUM(B.CB), 0) / (NVL(SUM(B.QTY), 0)))) AS
                  NUMBER(18, 6)) AS END_DJ, /*0月结、1入库、2出库*/
             CAST(DECODE(NVL(SUM(B.QTY), 0),
                         0,
                         0,
                         (NVL(SUM(B.HSCB), 0) / (NVL(SUM(B.QTY), 0)))) AS
                  NUMBER(18, 2)) AS END_HSDJ,
             CAST(NVL(SUM(B.CB), 0) AS NUMBER(18, 6)) AS END_CB,
             CAST(NVL(SUM(B.HSCB), 0) AS NUMBER(18, 2)) AS END_HSCB
        FROM T_GD_TEMP_ORDER_SOTRE_MONTH A /*所有单据*/
        join T_GD_TEMP_ORDER_SOTRE_MONTH B /*期末汇总*/
             on A.PART_NO = B.PART_NO AND B.ORDERDATE <= A.ORDERDATE
       WHERE 1=1
         AND A.ORDERDATE < '#START_TIME#'
       GROUP BY A.NET_NAME,A.ID,A.TYPE,A.BILL_TYPE,A.ORDERDATE,A.PART_NO,A.PART_NAME,A.BILL_CODE,A.CREATOR,A.REMARK,A.BILL_NAME,A.QTY,A.DJ,A.HSDJ,A.CB,A.HSCB,B.DJ,B.HSDJ
       ORDER BY A.ORDERDATE DESC /*按时间倒序排列*/
   )
WHERE ROWNUM < 2 /*只取一条*/    
UNION ALL
SELECT rownum AS ROWNO, B.*
  FROM (SELECT A.NET_NAME,
               A.ID,
               A.TYPE,
               A.BILL_TYPE,
               to_char(A.ORDERDATE, 'yyyy-mm-dd') as ORDERDATE,
               A.PART_NO,
               A.PART_NAME,
               A.BILL_CODE,
               NVL(C.EMP_NAME, A.CREATOR) AS CREATOR,
               A.REMARK,
               A.BILL_NAME,
               DECODE(A.TYPE, '0', CAST(A.QTY AS NUMBER(18, 4)), NULL) AS IN_QTY,
               DECODE(A.TYPE, '0', CAST(A.DJ AS NUMBER(18, 6)), NULL) AS IN_DJ,
               DECODE(A.TYPE, '0', CAST(A.HSDJ AS NUMBER(18, 2)), NULL) AS IN_HSDJ,
               DECODE(A.TYPE, '0', CAST(A.CB AS NUMBER(18, 6)), NULL) AS IN_CB,
               DECODE(A.TYPE, '0', CAST(A.HSCB AS NUMBER(18, 2)), NULL) AS IN_HSCB,
               /*出库*/
               DECODE(A.TYPE, '1', CAST(-A.QTY AS NUMBER(18, 4)), NULL) AS OUT_QTY,
               DECODE(A.TYPE, '1', CAST(A.DJ AS NUMBER(18, 6)), NULL) AS OUT_DJ,
               DECODE(A.TYPE, '1', CAST(A.HSDJ AS NUMBER(18, 2)), NULL) AS OUT_HSDJ,
               DECODE(A.TYPE, '1', CAST(-A.CB AS NUMBER(18, 6)), NULL) AS OUT_CB,
               DECODE(A.TYPE, '1', CAST(-A.HSCB AS NUMBER(18, 2)), NULL) AS OUT_HSCB,
               /*期末数*/
               CAST(NVL(SUM(B.QTY), 0) AS NUMBER(18, 4)) AS END_QTY, /*0月结、1入库、2出库*/
               CAST(DECODE(NVL(SUM(B.QTY), 0),
                           0,
                           0,
                           (NVL(SUM(B.CB), 0) / (NVL(SUM(B.QTY), 0)))) AS
                    NUMBER(18, 6)) AS END_DJ, /*0月结、1入库、2出库*/
               CAST(DECODE(NVL(SUM(B.QTY), 0),
                           0,
                           0,
                           (NVL(SUM(B.HSCB), 0) / (NVL(SUM(B.QTY), 0)))) AS
                    NUMBER(18, 2)) AS END_HSDJ,
               CAST(NVL(SUM(B.CB), 0) AS NUMBER(18, 6)) AS END_CB,
               CAST(NVL(SUM(B.HSCB), 0) AS NUMBER(18, 2)) AS END_HSCB
          FROM T_GD_TEMP_ORDER_SOTRE_MONTH A
          JOIN T_GD_TEMP_ORDER_SOTRE_MONTH B
            ON A.PART_NO = B.PART_NO
          LEFT JOIN T_MDM_ORG_ACCOUNT D
            ON A.CREATOR = D.LOGIN_ID
          LEFT JOIN T_MDM_ORG_EMPLOYEE C
            ON D.EMP_ID = C.EMP_ID
         WHERE A.PART_NO = B.PART_NO
           AND B.ORDERDATE <= A.ORDERDATE
           AND (A.ORDERDATE >= '#START_TIME#' AND A.ORDERDATE < '#END_TIME#' + 1)
         GROUP BY A.NET_NAME,A.ID,A.TYPE,A.BILL_TYPE,A.ORDERDATE,A.PART_NO,A.PART_NAME,A.BILL_CODE,A.CREATOR,C.EMP_NAME,A.REMARK,A.BILL_NAME,A.QTY,A.DJ,A.HSDJ,A.CB,A.HSCB
         ORDER BY A.ORDERDATE) B
;

```

