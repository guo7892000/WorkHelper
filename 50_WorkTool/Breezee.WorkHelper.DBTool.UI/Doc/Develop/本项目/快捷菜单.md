## 本项目-快捷菜单

### 快捷菜单
```
// 加载快捷菜单
private void LoadShortCutMenu()
{
    string sPathConfig = GlobalContext.PathConfig();
    if (!Directory.Exists(sPathConfig))
    {
        Directory.CreateDirectory(sPathConfig); 
    }
    string strShortCutFilePath = Path.Combine(sPathConfig, MiniStaticString.ShortCutMenuFileName);
    if (!File.Exists(strShortCutFilePath))
    {
        XmlDocument xmlShortCut = new XmlDocument();
        XmlElement xmRoot = xmlShortCut.CreateElement("xml");
        xmlShortCut.AppendChild(xmRoot);
        xmlShortCut.Save(strShortCutFilePath);
        //
        _ShortCutMenuList = new ShortCutList();
        _ShortCutMenuList.AddShortCutItem += AddShortCutMenuItem;//新增快捷菜单事件
        _ShortCutMenuList.Dock = DockStyle.Fill;
        pnlDesktop.Controls.Add(_ShortCutMenuList);
    }
    else
    {
        XmlDocument xmlMenu = new XmlDocument();
        xmlMenu.Load(strShortCutFilePath);
        XmlNodeList xmlList = xmlMenu.SelectNodes("xml/Menu");
        _ShortCutMenuList = new ShortCutList();
        _ShortCutMenuList.AddShortCutItem += AddShortCutMenuItem;//新增快捷菜单事件

        foreach (XmlNode xnModel in xmlList)
        {
            if (xnModel.NodeType == XmlNodeType.Comment)
            {
                continue;
            }
            string strGuid = xnModel.GetAttributeValue("Guid");
            if (_MenuDic.ContainsKey(strGuid))
            {
                ShortCutItem scItem = new ShortCutItem(_MenuDic[strGuid]);
                scItem.ShortCutItemClick += ShortCutMenuItem_Click;//点击快捷菜单事件
                scItem.ShortCutItemCancel += CancelShortCutMenuItem_Click;//取消快捷菜单事件
                scItem.ShortCutItemoMoveFirst += MoveFirstShortCutMenuItem_Click;
                scItem.ShortCutItemoMoveLast += MoveLastShortCutMenuItem_Click;
                scItem.ShortCutItemoMoveBefore += MoveBeforShortCutMenuItem_Click;
                scItem.ShortCutItemoMoveBack += MoveNextShortCutMenuItem_Click;
                _ShortCutMenuList.AddItem(scItem);
            }
        }
        //
        _ShortCutMenuList.Dock = DockStyle.Fill;
        pnlDesktop.Controls.Add(_ShortCutMenuList);

    }
}

#region 快捷菜单项点击事件
private void ShortCutMenuItem_Click(object sender, ShortCutItemClickEventArgs e)
{
    OpenMenu(e.Menu, true);
}
#endregion

#region 取消快捷菜单项点击事件
private void CancelShortCutMenuItem_Click(object sender, ShortCutItemClickEventArgs e)
{
    SaveShortCutMenuConfig(e.Menu, ShortMenuEventEnum.Cancel);
}
#endregion

#region 增加快捷菜单项点击事件
private void AddShortCutMenuItem(object sender, ShortCutItemClickEventArgs e)
{
    SaveShortCutMenuConfig(e.Menu, ShortMenuEventEnum.New);
}
#endregion

#region 移动快捷菜单项事件
/// <summary>
/// 移到首位
/// </summary>
/// <param name="sender"></param>
/// <param name="e"></param>
private void MoveFirstShortCutMenuItem_Click(object sender, ShortCutItemClickEventArgs e)
{
    SaveShortCutMenuConfig(e.Menu, ShortMenuEventEnum.MoveFirst);
}
/// <summary>
/// 移到最后
/// </summary>
/// <param name="sender"></param>
/// <param name="e"></param>
private void MoveLastShortCutMenuItem_Click(object sender, ShortCutItemClickEventArgs e)
{
    SaveShortCutMenuConfig(e.Menu, ShortMenuEventEnum.MoveLast);
}
/// <summary>
/// 前移一位
/// </summary>
/// <param name="sender"></param>
/// <param name="e"></param>
private void MoveBeforShortCutMenuItem_Click(object sender, ShortCutItemClickEventArgs e)
{
    SaveShortCutMenuConfig(e.Menu, ShortMenuEventEnum.MoveBefore);
}
/// <summary>
/// 后移一位
/// </summary>
/// <param name="sender"></param>
/// <param name="e"></param>
private void MoveNextShortCutMenuItem_Click(object sender, ShortCutItemClickEventArgs e)
{
    SaveShortCutMenuConfig(e.Menu, ShortMenuEventEnum.MoveNext);
}
#endregion

// 保存快捷菜单配置
private void SaveShortCutMenuConfig(MenuEntity dMenu, ShortMenuEventEnum menuEventEnum)
{
    string strShortCutFilePath = Path.Combine(GlobalContext.PathConfig(), MiniStaticString.ShortCutMenuFileName);
    XmlDocument xmlMenu = new XmlDocument();
    xmlMenu.Load(strShortCutFilePath);
    XmlNodeList xmlList = xmlMenu.SelectNodes("xml/Menu");
    XmlNode xnRemove = xmlMenu.SelectSingleNode("xml/Menu[@Guid='" + dMenu.Guid + "']");
    if (xnRemove != null)
    {
        if (menuEventEnum == ShortMenuEventEnum.Cancel)
        {
            xnRemove.ParentNode.RemoveChild(xnRemove);
            //从快捷菜单中移除
            if (_ShortCutMenuList.ItemList.ContainsKey(dMenu.Guid))
            {
                _ShortCutMenuList.MenuListPanl.Controls.Remove(_ShortCutMenuList.ItemList[dMenu.Guid]);
                _ShortCutMenuList.ItemList.Remove(dMenu.Guid);

            }
        }
    }
    else
    {
        if (menuEventEnum== ShortMenuEventEnum.New)
        {
            XmlElement xnNew = xmlMenu.CreateElement("Menu");
            xnNew.SetAttribute("Guid", dMenu.Guid);
            xnNew.SetAttribute("Name", dMenu.Name);
            xmlMenu.DocumentElement.AppendChild(xnNew);

            if (!_ShortCutMenuList.ItemList.ContainsKey(dMenu.Guid))
            {
                ShortCutItem scItem = new ShortCutItem(dMenu);
                scItem.ShortCutItemClick += ShortCutMenuItem_Click;//点击快捷菜单事件
                scItem.ShortCutItemCancel += CancelShortCutMenuItem_Click;//取消快捷菜单事件
                scItem.ShortCutItemoMoveFirst += MoveFirstShortCutMenuItem_Click;
                scItem.ShortCutItemoMoveLast += MoveLastShortCutMenuItem_Click;
                scItem.ShortCutItemoMoveBefore += MoveBeforShortCutMenuItem_Click;
                scItem.ShortCutItemoMoveBack += MoveNextShortCutMenuItem_Click;
                _ShortCutMenuList.AddItem(scItem);
            }
        }
    }

    #region 快捷方式的位置调整
    if (!(menuEventEnum == ShortMenuEventEnum.New || menuEventEnum == ShortMenuEventEnum.Cancel))
    {
        int iIndex = 0;
        Control control = null;
        bool canSet = false;
        if (menuEventEnum == ShortMenuEventEnum.MoveFirst)
        {
            // 设置当前控件索引=0
            _ShortCutMenuList.MenuListPanl.Controls.SetChildIndex(_ShortCutMenuList.ItemList[dMenu.Guid], 0);                  

            foreach (Control item in _ShortCutMenuList.MenuListPanl.Controls)
            {
                ShortCutItem curShortCutItem = (ShortCutItem)item;
                if (curShortCutItem.Menu.Guid.Equals(dMenu.Guid))
                {
                    // 调整XML配置文件中内容位置
                    xmlMenu.DocumentElement.InsertBefore(xnRemove, xnRemove.ParentNode.FirstChild);
                    continue;
                }
                // 所有控件索引+1
                _ShortCutMenuList.MenuListPanl.Controls.SetChildIndex(item, _ShortCutMenuList.MenuListPanl.Controls.GetChildIndex(item) + 1);
            }
        }
        else if (menuEventEnum == ShortMenuEventEnum.MoveLast)
        {

            foreach (Control item in _ShortCutMenuList.MenuListPanl.Controls)
            {
                iIndex = _ShortCutMenuList.MenuListPanl.Controls.GetChildIndex(item);
            }
            // 设置当前控件索引=最后控件的索引+1
            _ShortCutMenuList.MenuListPanl.Controls.SetChildIndex(_ShortCutMenuList.ItemList[dMenu.Guid], iIndex + 1);
            xmlMenu.DocumentElement.InsertAfter(xnRemove, xnRemove.ParentNode.LastChild); // 调整XML配置文件中内容位置
        }
        else if (menuEventEnum == ShortMenuEventEnum.MoveBefore)
        {
            foreach (Control item in _ShortCutMenuList.MenuListPanl.Controls)
            {
                ShortCutItem curShortCutItem = (ShortCutItem)item;
                if (curShortCutItem.Menu.Guid.Equals(dMenu.Guid))
                {
                    // 交换索引值
                    _ShortCutMenuList.MenuListPanl.Controls.SetChildIndex(control, _ShortCutMenuList.MenuListPanl.Controls.GetChildIndex(item));
                    _ShortCutMenuList.MenuListPanl.Controls.SetChildIndex(item, iIndex);
                    xmlMenu.DocumentElement.InsertBefore(xnRemove, xnRemove.PreviousSibling); // 调整XML配置文件中内容位置
                    break;
                }
                // 得到上次循环控件索引值
                iIndex = _ShortCutMenuList.MenuListPanl.Controls.GetChildIndex(item);
                control = item;
            }
        }
        else if (menuEventEnum == ShortMenuEventEnum.MoveNext)
        {
            foreach (Control item in _ShortCutMenuList.MenuListPanl.Controls)
            {
                if (canSet)
                {
                    // 交换索引值
                    int iIndexNew = _ShortCutMenuList.MenuListPanl.Controls.GetChildIndex(item);
                    _ShortCutMenuList.MenuListPanl.Controls.SetChildIndex(item, iIndex);
                    _ShortCutMenuList.MenuListPanl.Controls.SetChildIndex(control, iIndexNew);
                    xmlMenu.DocumentElement.InsertAfter(xnRemove, xnRemove.NextSibling); // 调整XML配置文件中内容位置
                    break;
                }

                ShortCutItem curShortCutItem = (ShortCutItem)item;
                if (curShortCutItem.Menu.Guid.Equals(dMenu.Guid))
                {
                    canSet = true;
                    // 得到上次循环控件索引值
                    iIndex = _ShortCutMenuList.MenuListPanl.Controls.GetChildIndex(item);
                    control = item;
                }
            }
        }
    } 
    #endregion
    xmlMenu.Save(strShortCutFilePath);
}


#region 打开窗体方法
private void OpenMenu(MenuEntity dOpenMenu, bool IsExpandTreeNode)
{
    if (dOpenMenu == null || dOpenMenu.MenuType != MenuType.Menu)
    {
        return;
    }

    //判断窗体是否已经打开
    foreach (Form frm in MdiChildren)
    {
        MenuEntity dMenuFrm = frm.Tag as MenuEntity;
        //使用同菜单不同窗体GUID
        if (dMenuFrm.SameMenuNewFormGuid.Equals(dOpenMenu.SameMenuNewFormGuid))
        {
            MenuEntity selectMenu = tcMenu.SelectedTab.Tag as MenuEntity;
            //选中页签
            if (tcMenu.SelectedTab == tpgDesktop || selectMenu.SameMenuNewFormGuid != dMenuFrm.SameMenuNewFormGuid)
            {
                tcMenu.SelectedTab = tcMenu.TabPages[dMenuFrm.SameMenuNewFormGuid];
            }
            txbMenuPath.Text = dOpenMenu.FullPath;
            pnlDesktop.Hide();
            frm.Activate();
            WinFormContext.Instance.CurrentForm = frm;
            //全局提示信息显示为当前菜单的提示信息
            if(frm is BaseForm)
            {
                txbGlobalMsg.Text = ((BaseForm)frm).LastestTipMsg;
            }
            return;
        }
    }

    if (this.GetChildCount() > WinFormContext.Instance.MaxOpenFormNum - 1)
    {
        MessageBox.Show(string.Format("您打开的窗口超过了最大配置数{0}，不能再打开更多窗体。你可以在【开始】->【环境设置】中修改！",WinFormContext.Instance.MaxOpenFormNum), "温馨提示");
        return;
    }

    if (IsExpandTreeNode)
    {
        OpenTreeNodeMenu(dOpenMenu.Name);
    }

    //克隆一个新的菜单对象
    MenuEntity dMenu = dOpenMenu.Clone();
    //反射得到窗体
    Assembly dll = Assembly.LoadFile(Path.Combine(_strAppPath, dMenu.DLLName));
    object form = dll.CreateInstance(dMenu.FormName);
    if (form is Form)
    {
        Form newForm = form as Form;
        newForm.Tag = dMenu;
        newForm.MdiParent = this;
        newForm.WindowState = FormWindowState.Maximized;
        newForm.Activated += ChildForm_Active;
        newForm.FormClosed += MdiChild_Close;
        //增加页签：使用同菜单不同窗体GUID
        tcMenu.TabPages.Add(dMenu.SameMenuNewFormGuid, dMenu.Name);
        tcMenu.TabPages[dMenu.SameMenuNewFormGuid].Tag = dMenu;
        tcMenu.SelectedTab = tcMenu.TabPages[dMenu.SameMenuNewFormGuid];
        txbMenuPath.Text = dMenu.FullPath;
                
        newForm.Show();
        WinFormContext.Instance.CurrentForm = newForm;
        txbMenuPath.BackColor = txbMenuPath.Parent.BackColor;
        //给窗体加上统一显示提示信息事件委托
        if (newForm is BaseForm)
        {
            BaseForm fr = newForm as BaseForm;
            fr.MainFormMode = MainFormModelEnum.Mini;
            fr.MenuName = dMenu.Name;
            fr.ShowGlobalMsg += ShowGlobalMsg_Click;//显示全局提示信息
        }
    }
    else
    {
        MsgHelper.ShowErr("配置错误，【" + dMenu.Name + "】菜单不是窗体类型！");
    }
} 
#endregion
```
